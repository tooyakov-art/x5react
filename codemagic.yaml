workflows:
  ios-workflow:
    name: iOS Release
    max_build_duration: 120
    integrations:
      # !!! –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å –∏–º—è —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–≤–æ–∏–º –∫–ª—é—á–æ–º !!!
      app_store_connect: Codemagic Fresh
    environment:
      node: 22
      xcode: latest
      cocoapods: default
    scripts:
      - name: Install dependencies
        script: |
          npm install
          npm install -g ios-deploy
          gem install cocoapods xcodeproj
      
      - name: Build web app
        script: |
          npm run build
      
      - name: Setup Capacitor iOS
        script: |
          rm -rf ios
          npx cap add ios
          npx cap sync ios
          if [ -f "ios/App/Podfile" ]; then
            cd ios/App
            pod install
          fi

      - name: Fetch Signing Files
        script: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º v2 —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å –≥–ª—é—á–Ω—ã–µ —Å—Ç–∞—Ä—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
          keychain initialize
          app-store-connect fetch-signing-files "com.x5pro.app.v2" --type IOS_APP_STORE --create
          keychain add-certificates

      - name: üíé Force Link Profile (Ruby Hack)
        script: |
          ruby -r xcodeproj -e '
            require "date"
            profiles_dir = File.expand_path("~/Library/MobileDevice/Provisioning Profiles")
            profile_path = Dir["#{profiles_dir}/*.mobileprovision"].max_by { |f| File.mtime(f) }
            
            if profile_path.nil?
              puts "‚ùå –û–®–ò–ë–ö–ê: –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!"
              exit 1
            end
            
            uuid = File.read(profile_path).match(/<key>UUID<\/key>\s*<string>(.*?)<\/string>/)[1]
            puts "‚úÖ UUID –ø—Ä–æ—Ñ–∏–ª—è: #{uuid}"
            
            project_path = "ios/App/App.xcodeproj"
            project = Xcodeproj::Project.open(project_path)
            
            project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings["DEVELOPMENT_TEAM"] = "F8LA8PC4U6"
                # –í–ê–ñ–ù–û: ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å v2
                config.build_settings["PRODUCT_BUNDLE_IDENTIFIER"] = "com.x5pro.app.v2"
                config.build_settings["CODE_SIGN_STYLE"] = "Manual"
                config.build_settings["CODE_SIGN_IDENTITY"] = "iPhone Distribution"
                config.build_settings["PROVISIONING_PROFILE"] = uuid
                config.build_settings["PROVISIONING_PROFILE_SPECIFIER"] = uuid
              end
            end
            project.save
          '

      - name: Build IPA
        script: |
          xcode-project build-ipa \
            --project ios/App/App.xcodeproj \
            --scheme App \
            --config Release
    artifacts:
      - build/ios/ipa/*.ipa
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true